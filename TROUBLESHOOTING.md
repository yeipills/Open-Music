# ğŸš¨ GuÃ­a de SoluciÃ³n de Problemas - Open Music Bot

## ğŸ“‹ Ãndice de Problemas

1. [ğŸ”§ Problemas de InstalaciÃ³n](#-problemas-de-instalaciÃ³n)
2. [ğŸµ Problemas de yt-dlp](#-problemas-de-yt-dlp)
3. [ğŸª Problemas de Cookies](#-problemas-de-cookies)
4. [ğŸ”Š Problemas de Audio](#-problemas-de-audio)
5. [ğŸ³ Problemas de Docker](#-problemas-de-docker)
6. [âš¡ Problemas de Performance](#-problemas-de-performance)
7. [ğŸ“Š Herramientas de DiagnÃ³stico](#-herramientas-de-diagnÃ³stico)

---

## ğŸ”§ Problemas de InstalaciÃ³n

### âŒ Error: `DISCORD_TOKEN not found`

**SÃ­ntomas:**
```
Error: DISCORD_TOKEN environment variable not set
```

**Causas posibles:**
- Token no configurado en `.env`
- Archivo `.env` en ubicaciÃ³n incorrecta
- Variables de entorno no cargadas

**Soluciones:**

1. **Verificar archivo .env:**
```bash
# Verificar que existe
ls -la .env

# Verificar contenido
cat .env | grep DISCORD_TOKEN
```

2. **Configurar correctamente:**
```bash
# Crear desde template
cp .env.example .env

# Editar con tu token
nano .env

# Verificar formato (sin espacios extra)
DISCORD_TOKEN=YOUR_BOT_TOKEN_HERE
```

3. **Para Docker:**
```bash
# Verificar que docker-compose lee el .env
docker-compose config | grep DISCORD_TOKEN
```

### âŒ Error: `opus link error`

**SÃ­ntomas:**
```
error: linking with `cc` failed
undefined reference to `opus_encoder_create`
```

**SoluciÃ³n:**
```bash
# Ubuntu/Debian
sudo apt install libopus-dev pkg-config

# CentOS/RHEL/Fedora
sudo dnf install opus-devel pkgconfig

# macOS
brew install opus pkg-config

# Limpiar y recompilar
cargo clean
cargo build --release
```

### âŒ Error: `cmake not found`

**SÃ­ntomas:**
```
error: failed to run custom build command for `cmake`
```

**SoluciÃ³n:**
```bash
# Ubuntu/Debian
sudo apt install cmake build-essential

# CentOS/RHEL/Fedora
sudo dnf install cmake gcc gcc-c++

# macOS
brew install cmake

# Verificar instalaciÃ³n
cmake --version
```

---

## ğŸµ Problemas de yt-dlp

### âŒ Error: `yt-dlp not found`

**SÃ­ntomas:**
```
Error: Command 'yt-dlp' not found
```

**Soluciones:**

1. **InstalaciÃ³n bÃ¡sica:**
```bash
# MÃ©todo recomendado
pip3 install --upgrade yt-dlp

# Verificar instalaciÃ³n
yt-dlp --version
which yt-dlp
```

2. **Para sistemas con permisos restringidos:**
```bash
# InstalaciÃ³n en user space
pip3 install --user --upgrade yt-dlp

# Agregar al PATH
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

3. **InstalaciÃ³n alternativa:**
```bash
# Usando pipx (recomendado para herramientas)
sudo apt install pipx
pipx install yt-dlp
pipx upgrade yt-dlp
```

### âŒ Error: `HTTP Error 429: Too Many Requests`

**SÃ­ntomas:**
```
ERROR: [youtube] Video unavailable: HTTP Error 429
```

**Causas:**
- Rate limiting de YouTube
- IP bloqueada temporalmente
- Cookies expiradas o invÃ¡lidas

**Soluciones:**

1. **Actualizar cookies:**
```bash
# Renovar cookies desde navegador
# Ver secciÃ³n "Problemas de Cookies"
```

2. **Esperar y reintentar:**
```bash
# Reiniciar bot despuÃ©s de 15-30 minutos
docker-compose restart
```

3. **Usar proxy (avanzado):**
```bash
# Agregar a config/config
--proxy socks5://proxy-server:port
```

### âŒ Error: `Video unavailable`

**SÃ­ntomas:**
```
ERROR: [youtube] Video unavailable
Audio choppy or not playing
```

**Soluciones:**

1. **Verificar URL:**
```bash
# Test manual
yt-dlp --print "%(title)s" "URL_DEL_VIDEO"
```

2. **Actualizar yt-dlp:**
```bash
pip3 install --upgrade yt-dlp
```

3. **Usar formato alternativo:**
```bash
# Editar config/config
--format "worstaudio/worst"  # Para testing
```

### âŒ Error: `Search timeout`

**SÃ­ntomas:**
- BÃºsquedas que tardan mÃ¡s de 30 segundos
- Bot se queda "pensando"
- Comandos que no responden

**Soluciones:**

1. **Verificar optimizaciones:**
```bash
# Verificar configuraciÃ³n optimizada en config/config
cat config/config | grep -E "(socket-timeout|retries|fragment-retries)"
```

2. **Reducir timeouts:**
```bash
# Editar config/config
--socket-timeout 10
--retries 1
--fragment-retries 1
```

3. **Test de conectividad:**
```bash
# Test de velocidad
time yt-dlp --print "%(title)s" "ytsearch1:test music"
```

---

## ğŸª Problemas de Cookies

### âŒ Cookies invÃ¡lidas o expiradas

**SÃ­ntomas:**
- Videos no se reproducen
- Error 403 Forbidden
- Rate limiting excesivo

**DiagnÃ³stico:**
```bash
# Verificar cookies
ls -la config/cookies.txt

# Verificar formato
head -5 config/cookies.txt
```

**Soluciones:**

1. **Extraer cookies frescas:**

**MÃ©todo Chrome:**
```bash
# 1. Instalar extensiÃ³n "cookies.txt"
# 2. Ir a youtube.com y loguearse
# 3. Exportar cookies
# 4. Copiar a config/cookies.txt
```

**MÃ©todo Firefox:**
```bash
# 1. Instalar "Export Cookies"
# 2. Ir a youtube.com
# 3. Exportar en formato Netscape
# 4. Copiar a config/cookies.txt
```

2. **Validar formato de cookies:**
```bash
# Verificar que empiecen con:
head -2 config/cookies.txt
# Debe mostrar:
# # Netscape HTTP Cookie File
# # This file is generated by yt-dlp. Do not edit.
```

3. **Test de cookies:**
```bash
# Test con cookies
yt-dlp --cookies config/cookies.txt --print "%(title)s" "ytsearch1:test"

# Test sin cookies
yt-dlp --print "%(title)s" "ytsearch1:test"
```

### âŒ UbicaciÃ³n incorrecta de cookies

**SÃ­ntomas:**
```
WARNING: No se encontraron cookies
```

**VerificaciÃ³n:**
```bash
# Verificar ubicaciones buscadas
find . -name "cookies.txt" 2>/dev/null

# Verificar permisos
ls -la config/cookies.txt
```

**SoluciÃ³n:**
```bash
# Crear directorio si no existe
mkdir -p config

# Copiar cookies a ubicaciÃ³n correcta
cp cookies.txt config/cookies.txt

# Verificar permisos
chmod 644 config/cookies.txt
```

---

## ğŸ”Š Problemas de Audio

### âŒ Audio entrecortado (choppy)

**SÃ­ntomas:**
- Audio que se corta
- ReproducciÃ³n irregular
- Lag en la reproducciÃ³n

**Causas:**
- CPU insuficiente
- Memoria insuficiente
- Problemas de red
- ConfiguraciÃ³n de bitrate muy alta

**Soluciones:**

1. **Verificar recursos:**
```bash
# Monitorear CPU y memoria
top -p $(pgrep open-music)

# Para Docker
docker stats open-music-bot
```

2. **Reducir calidad de audio:**
```bash
# Editar .env
OPUS_BITRATE=64000    # Reducir de 128000
FRAME_SIZE=480        # Reducir de 960
```

3. **Optimizar configuraciÃ³n:**
```bash
# Editar config/config
--http-chunk-size 2M  # Reducir de 5M
--concurrent-fragments 1  # Reducir de 2
```

### âŒ Sin audio / Bot mudo

**SÃ­ntomas:**
- Bot se conecta pero no reproduce
- Comandos funcionan pero sin sonido
- "Now playing" muestra pero no se escucha

**DiagnÃ³stico:**
```bash
# Verificar conexiÃ³n de voz
# En Discord, verificar que el bot estÃ© en el canal
```

**Soluciones:**

1. **Verificar permisos Discord:**
- âœ… Connect (Voice)
- âœ… Speak (Voice)
- âœ… Use Voice Activity

2. **Reiniciar conexiÃ³n de audio:**
```bash
# Comandos en Discord
/leave
/join
/play test music
```

3. **Verificar logs de audio:**
```bash
# Logs especÃ­ficos de songbird
RUST_LOG=songbird=debug docker-compose logs -f
```

### âŒ Audio con latencia alta

**SÃ­ntomas:**
- Delay entre comando y reproducciÃ³n
- Audio desfasado

**Soluciones:**
```bash
# Optimizar buffer de audio
DEFAULT_VOLUME=0.3    # Volumen mÃ¡s bajo
OPUS_BITRATE=96000    # Bitrate moderado

# Reducir frame size
FRAME_SIZE=480
```

---

## ğŸ³ Problemas de Docker

### âŒ Error: `docker-compose not found`

**SÃ­ntomas:**
```bash
bash: docker-compose: command not found
```

**Soluciones:**

1. **Docker Compose v2 (recomendado):**
```bash
# Usar comando nuevo
docker compose up -d

# Crear alias si es necesario
echo 'alias docker-compose="docker compose"' >> ~/.bashrc
```

2. **Instalar Docker Compose v1:**
```bash
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### âŒ Error: `Permission denied` (Docker)

**SÃ­ntomas:**
```
permission denied while trying to connect to Docker daemon
```

**Soluciones:**
```bash
# Agregar usuario al grupo docker
sudo usermod -aG docker $USER

# Logout y login, o usar:
newgrp docker

# Verificar
docker --version
```

### âŒ Contenedor se reinicia constantemente

**SÃ­ntomas:**
```bash
docker-compose ps
# Estado: Restarting
```

**DiagnÃ³stico:**
```bash
# Ver logs
docker-compose logs open-music

# Ver Ãºltimos errores
docker-compose logs --tail=20 open-music
```

**Soluciones comunes:**
1. Token invÃ¡lido
2. Memoria insuficiente
3. Variables de entorno faltantes

### âŒ Build timeout

**SÃ­ntomas:**
```
ERROR: Build failed with timeout
```

**Soluciones:**
```bash
# Aumentar timeout
DOCKER_BUILDKIT=1 docker-compose build --no-cache

# Build manual con mÃ¡s memoria
docker build --memory=4g --cpu-shares=2048 .

# Usar imagen pre-compilada (si disponible)
docker pull tu-usuario/open-music-bot:latest
```

---

## âš¡ Problemas de Performance

### âŒ Uso excesivo de CPU

**SÃ­ntomas:**
```bash
top
# open-music usando >50% CPU constantemente
```

**DiagnÃ³stico:**
```bash
# Profile de CPU
perf record -g -p $(pgrep open-music)
perf report

# Para Docker
docker stats open-music-bot
```

**Soluciones:**

1. **Optimizar configuraciÃ³n:**
```bash
# .env optimizations
WORKER_THREADS=2          # Limitar threads
CACHE_SIZE=50             # Reducir cache
AUDIO_CACHE_SIZE=25       # Reducir audio cache
```

2. **Reducir calidad:**
```bash
OPUS_BITRATE=64000        # Menor bitrate
DEFAULT_VOLUME=0.3        # Volumen menor
```

### âŒ Uso excesivo de Memoria

**SÃ­ntomas:**
- RAM >500MB
- Sistema lento
- OOM kills

**Soluciones:**
```bash
# Limitar memoria Docker
# En docker-compose.yml
deploy:
  resources:
    limits:
      memory: 256M

# Optimizar cache
CACHE_SIZE=25
MAX_QUEUE_SIZE=100
```

### âŒ BÃºsquedas muy lentas

**SÃ­ntomas:**
- BÃºsquedas >20 segundos
- Timeouts frecuentes

**Optimizaciones aplicadas en este bot:**
```bash
# config/config optimizado
--socket-timeout 15       # Reducido de 30
--retries 2              # Reducido de 5
--fragment-retries 1     # Reducido de 5
--concurrent-fragments 2 # Parallelismo
--http-chunk-size 5M     # Chunks optimizados
```

**VerificaciÃ³n:**
```bash
# Test de velocidad
time yt-dlp --print "%(title)s" "ytsearch1:milo j"
# DeberÃ­a ser <10 segundos
```

---

## ğŸ“Š Herramientas de DiagnÃ³stico

### ğŸ” Script de DiagnÃ³stico Completo

```bash
cat > ./scripts/diagnose.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸ” === DIAGNÃ“STICO COMPLETO ===" 
echo "Timestamp: $(date)"
echo ""

echo "ğŸ“‹ === SISTEMA ==="
echo "OS: $(uname -a)"
echo "CPU: $(nproc) cores"
echo "RAM: $(free -h | grep Mem | awk '{print $2}')"
echo "Disk: $(df -h . | tail -1 | awk '{print $4}') free"
echo ""

echo "ğŸ”§ === DEPENDENCIAS ==="
echo -n "Rust: "
rustc --version 2>/dev/null || echo "âŒ No instalado"
echo -n "Docker: "
docker --version 2>/dev/null || echo "âŒ No instalado"
echo -n "yt-dlp: "
yt-dlp --version 2>/dev/null || echo "âŒ No instalado"
echo -n "ffmpeg: "
ffmpeg -version 2>/dev/null | head -1 || echo "âŒ No instalado"
echo ""

echo "ğŸ“ === ARCHIVOS ==="
echo "Directorio actual: $(pwd)"
echo ".env: $([ -f .env ] && echo "âœ… Existe" || echo "âŒ Faltante")"
echo "Dockerfile: $([ -f Dockerfile ] && echo "âœ… Existe" || echo "âŒ Faltante")"
echo "docker-compose.yml: $([ -f docker-compose.yml ] && echo "âœ… Existe" || echo "âŒ Faltante")"
echo "config/cookies.txt: $([ -f config/cookies.txt ] && echo "âœ… Existe ($(wc -l < config/cookies.txt) lÃ­neas)" || echo "âŒ Faltante")"
echo ""

echo "ğŸŒ === CONECTIVIDAD ==="
timeout 5 curl -s https://discord.com > /dev/null && echo "Discord: âœ… Accesible" || echo "Discord: âŒ No accesible"
timeout 5 curl -s https://youtube.com > /dev/null && echo "YouTube: âœ… Accesible" || echo "YouTube: âŒ No accesible"
echo ""

echo "ğŸ³ === DOCKER ==="
if docker ps > /dev/null 2>&1; then
    echo "Docker daemon: âœ… Ejecutando"
    if docker-compose ps 2>/dev/null | grep -q open-music; then
        echo "Bot container: âœ… Ejecutando"
        docker stats open-music-bot --no-stream | tail -n +2
    else
        echo "Bot container: âŒ No ejecutando"
    fi
else
    echo "Docker daemon: âŒ No accesible"
fi
echo ""

echo "ğŸµ === YT-DLP TEST ==="
if command -v yt-dlp > /dev/null; then
    echo "Testing yt-dlp search..."
    timeout 15 yt-dlp --print "%(title)s" "ytsearch1:test music" 2>/dev/null && echo "yt-dlp: âœ… Funcional" || echo "yt-dlp: âŒ Con problemas"
else
    echo "yt-dlp: âŒ No disponible"
fi
echo ""

echo "ğŸ“Š === LOGS RECIENTES ==="
if docker-compose ps 2>/dev/null | grep -q open-music; then
    echo "Ãšltimas 5 lÃ­neas de logs:"
    docker-compose logs --tail=5 open-music 2>/dev/null || echo "No se pudieron obtener logs"
else
    echo "Bot no estÃ¡ ejecutando"
fi
echo ""

echo "âœ… === DIAGNÃ“STICO COMPLETADO ==="
EOF

chmod +x ./scripts/diagnose.sh
```

### ğŸ“ˆ Monitoring Continuo

```bash
cat > ./scripts/monitor.sh << 'EOF'
#!/bin/bash

while true; do
    clear
    echo "ğŸµ Open Music Bot - Monitor $(date)"
    echo "=========================================="
    
    if docker ps | grep -q open-music-bot; then
        echo "Status: âœ… RUNNING"
        echo ""
        echo "Resources:"
        docker stats open-music-bot --no-stream | tail -n +2
        echo ""
        echo "Recent logs:"
        docker logs --tail 3 open-music-bot 2>/dev/null
    else
        echo "Status: âŒ NOT RUNNING"
        echo ""
        echo "Last logs:"
        docker logs --tail 5 open-music-bot 2>/dev/null || echo "No logs available"
    fi
    
    echo ""
    echo "=========================================="
    echo "Press Ctrl+C to exit"
    sleep 10
done
EOF

chmod +x ./scripts/monitor.sh
```

### ğŸš¨ Auto-recovery Script

```bash
cat > ./scripts/auto-recovery.sh << 'EOF'
#!/bin/bash

LOG_FILE="./logs/recovery.log"
mkdir -p logs

log_msg() {
    echo "[$(date)] $1" | tee -a "$LOG_FILE"
}

while true; do
    if ! docker ps | grep -q open-music-bot; then
        log_msg "ğŸš¨ Bot not running, attempting restart..."
        
        # Intentar restart
        docker-compose restart > /dev/null 2>&1
        sleep 30
        
        if docker ps | grep -q open-music-bot; then
            log_msg "âœ… Bot restarted successfully"
        else
            log_msg "âŒ Restart failed, rebuilding..."
            docker-compose down > /dev/null 2>&1
            docker-compose up -d --build > /dev/null 2>&1
            sleep 60
            
            if docker ps | grep -q open-music-bot; then
                log_msg "âœ… Bot rebuilt and started"
            else
                log_msg "ğŸ’€ Critical failure, manual intervention required"
                # Enviar notificaciÃ³n (webhook, email, etc.)
            fi
        fi
    else
        # Bot running, check health
        if docker logs --tail 10 open-music-bot 2>/dev/null | grep -q "ERROR"; then
            log_msg "âš ï¸  Errors detected in logs, restarting preventively..."
            docker-compose restart > /dev/null 2>&1
            sleep 30
        fi
    fi
    
    sleep 60
done
EOF

chmod +x ./scripts/auto-recovery.sh
```

### ğŸ“ Obtener Ayuda

Si despuÃ©s de seguir esta guÃ­a aÃºn tienes problemas:

1. **ğŸ“‹ Ejecutar diagnÃ³stico:**
```bash
./scripts/diagnose.sh > diagnostico.txt
```

2. **ğŸ“ Recopilar informaciÃ³n:**
- Output del diagnÃ³stico
- Logs completos del bot
- Pasos exactos para reproducir el problema
- ConfiguraciÃ³n (sin tokens sensibles)

3. **ğŸ› Crear issue en GitHub:**
- Incluir toda la informaciÃ³n recopilada
- Usar labels apropiados (bug, help wanted, etc.)
- Seguir el template de issue

4. **ğŸ’¬ Soporte en vivo:**
- Servidor Discord del proyecto
- Discusiones en GitHub
- Stack Overflow con tags: rust, discord, yt-dlp

---

**ğŸµ Â¡La mayorÃ­a de problemas se resuelven con cookies frescas y dependencias actualizadas!**