# 🚨 Guía de Solución de Problemas - Open Music Bot

## 📋 Índice de Problemas

1. [🔧 Problemas de Instalación](#-problemas-de-instalación)
2. [🎵 Problemas de yt-dlp](#-problemas-de-yt-dlp)
3. [🍪 Problemas de Cookies](#-problemas-de-cookies)
4. [🔊 Problemas de Audio](#-problemas-de-audio)
5. [🐳 Problemas de Docker](#-problemas-de-docker)
6. [⚡ Problemas de Performance](#-problemas-de-performance)
7. [📊 Herramientas de Diagnóstico](#-herramientas-de-diagnóstico)

---

## 🔧 Problemas de Instalación

### ❌ Error: `DISCORD_TOKEN not found`

**Síntomas:**
```
Error: DISCORD_TOKEN environment variable not set
```

**Causas posibles:**
- Token no configurado en `.env`
- Archivo `.env` en ubicación incorrecta
- Variables de entorno no cargadas

**Soluciones:**

1. **Verificar archivo .env:**
```bash
# Verificar que existe
ls -la .env

# Verificar contenido
cat .env | grep DISCORD_TOKEN
```

2. **Configurar correctamente:**
```bash
# Crear desde template
cp .env.example .env

# Editar con tu token
nano .env

# Verificar formato (sin espacios extra)
DISCORD_TOKEN=YOUR_BOT_TOKEN_HERE
```

3. **Para Docker:**
```bash
# Verificar que docker-compose lee el .env
docker-compose config | grep DISCORD_TOKEN
```

### ❌ Error: `opus link error`

**Síntomas:**
```
error: linking with `cc` failed
undefined reference to `opus_encoder_create`
```

**Solución:**
```bash
# Ubuntu/Debian
sudo apt install libopus-dev pkg-config

# CentOS/RHEL/Fedora
sudo dnf install opus-devel pkgconfig

# macOS
brew install opus pkg-config

# Limpiar y recompilar
cargo clean
cargo build --release
```

### ❌ Error: `cmake not found`

**Síntomas:**
```
error: failed to run custom build command for `cmake`
```

**Solución:**
```bash
# Ubuntu/Debian
sudo apt install cmake build-essential

# CentOS/RHEL/Fedora
sudo dnf install cmake gcc gcc-c++

# macOS
brew install cmake

# Verificar instalación
cmake --version
```

---

## 🎵 Problemas de yt-dlp

### ❌ Error: `yt-dlp not found`

**Síntomas:**
```
Error: Command 'yt-dlp' not found
```

**Soluciones:**

1. **Instalación básica:**
```bash
# Método recomendado
pip3 install --upgrade yt-dlp

# Verificar instalación
yt-dlp --version
which yt-dlp
```

2. **Para sistemas con permisos restringidos:**
```bash
# Instalación en user space
pip3 install --user --upgrade yt-dlp

# Agregar al PATH
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc
```

3. **Instalación alternativa:**
```bash
# Usando pipx (recomendado para herramientas)
sudo apt install pipx
pipx install yt-dlp
pipx upgrade yt-dlp
```

### ❌ Error: `HTTP Error 429: Too Many Requests`

**Síntomas:**
```
ERROR: [youtube] Video unavailable: HTTP Error 429
```

**Causas:**
- Rate limiting de YouTube
- IP bloqueada temporalmente
- Cookies expiradas o inválidas

**Soluciones:**

1. **Actualizar cookies:**
```bash
# Renovar cookies desde navegador
# Ver sección "Problemas de Cookies"
```

2. **Esperar y reintentar:**
```bash
# Reiniciar bot después de 15-30 minutos
docker-compose restart
```

3. **Usar proxy (avanzado):**
```bash
# Agregar a config/config
--proxy socks5://proxy-server:port
```

### ❌ Error: `Video unavailable`

**Síntomas:**
```
ERROR: [youtube] Video unavailable
Audio choppy or not playing
```

**Soluciones:**

1. **Verificar URL:**
```bash
# Test manual
yt-dlp --print "%(title)s" "URL_DEL_VIDEO"
```

2. **Actualizar yt-dlp:**
```bash
pip3 install --upgrade yt-dlp
```

3. **Usar formato alternativo:**
```bash
# Editar config/config
--format "worstaudio/worst"  # Para testing
```

### ❌ Error: `Search timeout`

**Síntomas:**
- Búsquedas que tardan más de 30 segundos
- Bot se queda "pensando"
- Comandos que no responden

**Soluciones:**

1. **Verificar optimizaciones:**
```bash
# Verificar configuración optimizada en config/config
cat config/config | grep -E "(socket-timeout|retries|fragment-retries)"
```

2. **Reducir timeouts:**
```bash
# Editar config/config
--socket-timeout 10
--retries 1
--fragment-retries 1
```

3. **Test de conectividad:**
```bash
# Test de velocidad
time yt-dlp --print "%(title)s" "ytsearch1:test music"
```

---

## 🍪 Problemas de Cookies

### ❌ Cookies inválidas o expiradas

**Síntomas:**
- Videos no se reproducen
- Error 403 Forbidden
- Rate limiting excesivo

**Diagnóstico:**
```bash
# Verificar cookies
ls -la config/cookies.txt

# Verificar formato
head -5 config/cookies.txt
```

**Soluciones:**

1. **Extraer cookies frescas:**

**Método Chrome:**
```bash
# 1. Instalar extensión "cookies.txt"
# 2. Ir a youtube.com y loguearse
# 3. Exportar cookies
# 4. Copiar a config/cookies.txt
```

**Método Firefox:**
```bash
# 1. Instalar "Export Cookies"
# 2. Ir a youtube.com
# 3. Exportar en formato Netscape
# 4. Copiar a config/cookies.txt
```

2. **Validar formato de cookies:**
```bash
# Verificar que empiecen con:
head -2 config/cookies.txt
# Debe mostrar:
# # Netscape HTTP Cookie File
# # This file is generated by yt-dlp. Do not edit.
```

3. **Test de cookies:**
```bash
# Test con cookies
yt-dlp --cookies config/cookies.txt --print "%(title)s" "ytsearch1:test"

# Test sin cookies
yt-dlp --print "%(title)s" "ytsearch1:test"
```

### ❌ Ubicación incorrecta de cookies

**Síntomas:**
```
WARNING: No se encontraron cookies
```

**Verificación:**
```bash
# Verificar ubicaciones buscadas
find . -name "cookies.txt" 2>/dev/null

# Verificar permisos
ls -la config/cookies.txt
```

**Solución:**
```bash
# Crear directorio si no existe
mkdir -p config

# Copiar cookies a ubicación correcta
cp cookies.txt config/cookies.txt

# Verificar permisos
chmod 644 config/cookies.txt
```

---

## 🔊 Problemas de Audio

### ❌ Audio entrecortado (choppy)

**Síntomas:**
- Audio que se corta
- Reproducción irregular
- Lag en la reproducción

**Causas:**
- CPU insuficiente
- Memoria insuficiente
- Problemas de red
- Configuración de bitrate muy alta

**Soluciones:**

1. **Verificar recursos:**
```bash
# Monitorear CPU y memoria
top -p $(pgrep open-music)

# Para Docker
docker stats open-music-bot
```

2. **Reducir calidad de audio:**
```bash
# Editar .env
OPUS_BITRATE=64000    # Reducir de 128000
FRAME_SIZE=480        # Reducir de 960
```

3. **Optimizar configuración:**
```bash
# Editar config/config
--http-chunk-size 2M  # Reducir de 5M
--concurrent-fragments 1  # Reducir de 2
```

### ❌ Sin audio / Bot mudo

**Síntomas:**
- Bot se conecta pero no reproduce
- Comandos funcionan pero sin sonido
- "Now playing" muestra pero no se escucha

**Diagnóstico:**
```bash
# Verificar conexión de voz
# En Discord, verificar que el bot esté en el canal
```

**Soluciones:**

1. **Verificar permisos Discord:**
- ✅ Connect (Voice)
- ✅ Speak (Voice)
- ✅ Use Voice Activity

2. **Reiniciar conexión de audio:**
```bash
# Comandos en Discord
/leave
/join
/play test music
```

3. **Verificar logs de audio:**
```bash
# Logs específicos de songbird
RUST_LOG=songbird=debug docker-compose logs -f
```

### ❌ Audio con latencia alta

**Síntomas:**
- Delay entre comando y reproducción
- Audio desfasado

**Soluciones:**
```bash
# Optimizar buffer de audio
DEFAULT_VOLUME=0.3    # Volumen más bajo
OPUS_BITRATE=96000    # Bitrate moderado

# Reducir frame size
FRAME_SIZE=480
```

---

## 🐳 Problemas de Docker

### ❌ Error: `docker-compose not found`

**Síntomas:**
```bash
bash: docker-compose: command not found
```

**Soluciones:**

1. **Docker Compose v2 (recomendado):**
```bash
# Usar comando nuevo
docker compose up -d

# Crear alias si es necesario
echo 'alias docker-compose="docker compose"' >> ~/.bashrc
```

2. **Instalar Docker Compose v1:**
```bash
sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

### ❌ Error: `Permission denied` (Docker)

**Síntomas:**
```
permission denied while trying to connect to Docker daemon
```

**Soluciones:**
```bash
# Agregar usuario al grupo docker
sudo usermod -aG docker $USER

# Logout y login, o usar:
newgrp docker

# Verificar
docker --version
```

### ❌ Contenedor se reinicia constantemente

**Síntomas:**
```bash
docker-compose ps
# Estado: Restarting
```

**Diagnóstico:**
```bash
# Ver logs
docker-compose logs open-music

# Ver últimos errores
docker-compose logs --tail=20 open-music
```

**Soluciones comunes:**
1. Token inválido
2. Memoria insuficiente
3. Variables de entorno faltantes

### ❌ Build timeout

**Síntomas:**
```
ERROR: Build failed with timeout
```

**Soluciones:**
```bash
# Aumentar timeout
DOCKER_BUILDKIT=1 docker-compose build --no-cache

# Build manual con más memoria
docker build --memory=4g --cpu-shares=2048 .

# Usar imagen pre-compilada (si disponible)
docker pull tu-usuario/open-music-bot:latest
```

---

## ⚡ Problemas de Performance

### ❌ Uso excesivo de CPU

**Síntomas:**
```bash
top
# open-music usando >50% CPU constantemente
```

**Diagnóstico:**
```bash
# Profile de CPU
perf record -g -p $(pgrep open-music)
perf report

# Para Docker
docker stats open-music-bot
```

**Soluciones:**

1. **Optimizar configuración:**
```bash
# .env optimizations
WORKER_THREADS=2          # Limitar threads
CACHE_SIZE=50             # Reducir cache
AUDIO_CACHE_SIZE=25       # Reducir audio cache
```

2. **Reducir calidad:**
```bash
OPUS_BITRATE=64000        # Menor bitrate
DEFAULT_VOLUME=0.3        # Volumen menor
```

### ❌ Uso excesivo de Memoria

**Síntomas:**
- RAM >500MB
- Sistema lento
- OOM kills

**Soluciones:**
```bash
# Limitar memoria Docker
# En docker-compose.yml
deploy:
  resources:
    limits:
      memory: 256M

# Optimizar cache
CACHE_SIZE=25
MAX_QUEUE_SIZE=100
```

### ❌ Búsquedas muy lentas

**Síntomas:**
- Búsquedas >20 segundos
- Timeouts frecuentes

**Optimizaciones aplicadas en este bot:**
```bash
# config/config optimizado
--socket-timeout 15       # Reducido de 30
--retries 2              # Reducido de 5
--fragment-retries 1     # Reducido de 5
--concurrent-fragments 2 # Parallelismo
--http-chunk-size 5M     # Chunks optimizados
```

**Verificación:**
```bash
# Test de velocidad
time yt-dlp --print "%(title)s" "ytsearch1:milo j"
# Debería ser <10 segundos
```

---

## 📊 Herramientas de Diagnóstico

### 🔍 Script de Diagnóstico Completo

```bash
cat > ./scripts/diagnose.sh << 'EOF'
#!/bin/bash
set -e

echo "🔍 === DIAGNÓSTICO COMPLETO ===" 
echo "Timestamp: $(date)"
echo ""

echo "📋 === SISTEMA ==="
echo "OS: $(uname -a)"
echo "CPU: $(nproc) cores"
echo "RAM: $(free -h | grep Mem | awk '{print $2}')"
echo "Disk: $(df -h . | tail -1 | awk '{print $4}') free"
echo ""

echo "🔧 === DEPENDENCIAS ==="
echo -n "Rust: "
rustc --version 2>/dev/null || echo "❌ No instalado"
echo -n "Docker: "
docker --version 2>/dev/null || echo "❌ No instalado"
echo -n "yt-dlp: "
yt-dlp --version 2>/dev/null || echo "❌ No instalado"
echo -n "ffmpeg: "
ffmpeg -version 2>/dev/null | head -1 || echo "❌ No instalado"
echo ""

echo "📁 === ARCHIVOS ==="
echo "Directorio actual: $(pwd)"
echo ".env: $([ -f .env ] && echo "✅ Existe" || echo "❌ Faltante")"
echo "Dockerfile: $([ -f Dockerfile ] && echo "✅ Existe" || echo "❌ Faltante")"
echo "docker-compose.yml: $([ -f docker-compose.yml ] && echo "✅ Existe" || echo "❌ Faltante")"
echo "config/cookies.txt: $([ -f config/cookies.txt ] && echo "✅ Existe ($(wc -l < config/cookies.txt) líneas)" || echo "❌ Faltante")"
echo ""

echo "🌐 === CONECTIVIDAD ==="
timeout 5 curl -s https://discord.com > /dev/null && echo "Discord: ✅ Accesible" || echo "Discord: ❌ No accesible"
timeout 5 curl -s https://youtube.com > /dev/null && echo "YouTube: ✅ Accesible" || echo "YouTube: ❌ No accesible"
echo ""

echo "🐳 === DOCKER ==="
if docker ps > /dev/null 2>&1; then
    echo "Docker daemon: ✅ Ejecutando"
    if docker-compose ps 2>/dev/null | grep -q open-music; then
        echo "Bot container: ✅ Ejecutando"
        docker stats open-music-bot --no-stream | tail -n +2
    else
        echo "Bot container: ❌ No ejecutando"
    fi
else
    echo "Docker daemon: ❌ No accesible"
fi
echo ""

echo "🎵 === YT-DLP TEST ==="
if command -v yt-dlp > /dev/null; then
    echo "Testing yt-dlp search..."
    timeout 15 yt-dlp --print "%(title)s" "ytsearch1:test music" 2>/dev/null && echo "yt-dlp: ✅ Funcional" || echo "yt-dlp: ❌ Con problemas"
else
    echo "yt-dlp: ❌ No disponible"
fi
echo ""

echo "📊 === LOGS RECIENTES ==="
if docker-compose ps 2>/dev/null | grep -q open-music; then
    echo "Últimas 5 líneas de logs:"
    docker-compose logs --tail=5 open-music 2>/dev/null || echo "No se pudieron obtener logs"
else
    echo "Bot no está ejecutando"
fi
echo ""

echo "✅ === DIAGNÓSTICO COMPLETADO ==="
EOF

chmod +x ./scripts/diagnose.sh
```

### 📈 Monitoring Continuo

```bash
cat > ./scripts/monitor.sh << 'EOF'
#!/bin/bash

while true; do
    clear
    echo "🎵 Open Music Bot - Monitor $(date)"
    echo "=========================================="
    
    if docker ps | grep -q open-music-bot; then
        echo "Status: ✅ RUNNING"
        echo ""
        echo "Resources:"
        docker stats open-music-bot --no-stream | tail -n +2
        echo ""
        echo "Recent logs:"
        docker logs --tail 3 open-music-bot 2>/dev/null
    else
        echo "Status: ❌ NOT RUNNING"
        echo ""
        echo "Last logs:"
        docker logs --tail 5 open-music-bot 2>/dev/null || echo "No logs available"
    fi
    
    echo ""
    echo "=========================================="
    echo "Press Ctrl+C to exit"
    sleep 10
done
EOF

chmod +x ./scripts/monitor.sh
```

### 🚨 Auto-recovery Script

```bash
cat > ./scripts/auto-recovery.sh << 'EOF'
#!/bin/bash

LOG_FILE="./logs/recovery.log"
mkdir -p logs

log_msg() {
    echo "[$(date)] $1" | tee -a "$LOG_FILE"
}

while true; do
    if ! docker ps | grep -q open-music-bot; then
        log_msg "🚨 Bot not running, attempting restart..."
        
        # Intentar restart
        docker-compose restart > /dev/null 2>&1
        sleep 30
        
        if docker ps | grep -q open-music-bot; then
            log_msg "✅ Bot restarted successfully"
        else
            log_msg "❌ Restart failed, rebuilding..."
            docker-compose down > /dev/null 2>&1
            docker-compose up -d --build > /dev/null 2>&1
            sleep 60
            
            if docker ps | grep -q open-music-bot; then
                log_msg "✅ Bot rebuilt and started"
            else
                log_msg "💀 Critical failure, manual intervention required"
                # Enviar notificación (webhook, email, etc.)
            fi
        fi
    else
        # Bot running, check health
        if docker logs --tail 10 open-music-bot 2>/dev/null | grep -q "ERROR"; then
            log_msg "⚠️  Errors detected in logs, restarting preventively..."
            docker-compose restart > /dev/null 2>&1
            sleep 30
        fi
    fi
    
    sleep 60
done
EOF

chmod +x ./scripts/auto-recovery.sh
```

### 📞 Obtener Ayuda

Si después de seguir esta guía aún tienes problemas:

1. **📋 Ejecutar diagnóstico:**
```bash
./scripts/diagnose.sh > diagnostico.txt
```

2. **📝 Recopilar información:**
- Output del diagnóstico
- Logs completos del bot
- Pasos exactos para reproducir el problema
- Configuración (sin tokens sensibles)

3. **🐛 Crear issue en GitHub:**
- Incluir toda la información recopilada
- Usar labels apropiados (bug, help wanted, etc.)
- Seguir el template de issue

4. **💬 Soporte en vivo:**
- Servidor Discord del proyecto
- Discusiones en GitHub
- Stack Overflow con tags: rust, discord, yt-dlp

---

**🎵 ¡La mayoría de problemas se resuelven con cookies frescas y dependencias actualizadas!**