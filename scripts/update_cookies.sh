#!/bin/bash
# Script para actualizar cookies de YouTube - Open Music Bot

echo "ğŸª ACTUALIZADOR DE COOKIES DE YOUTUBE"
echo "===================================="

CONTAINER_NAME="open-music-bot"
COOKIE_DIR="./config"
CONTAINER_COOKIE_PATH="/home/openmusic/.config/yt-dlp"

echo ""
echo "ğŸ“‚ 1. VERIFICANDO DIRECTORIO DE COOKIES..."
echo "-----------------------------------------"

if [ ! -d "$COOKIE_DIR" ]; then
    echo "âŒ Directorio de configuraciÃ³n no encontrado: $COOKIE_DIR"
    echo "ğŸ”§ Creando directorio..."
    mkdir -p "$COOKIE_DIR"
fi

echo "âœ… Directorio de configuraciÃ³n: OK"

echo ""
echo "ğŸ”„ 2. GENERANDO NUEVAS COOKIES..."
echo "--------------------------------"

# Crear archivo de cookies actualizadas para 2025
cat > "$COOKIE_DIR/cookies.txt" << 'EOF'
# Netscape HTTP Cookie File
# Cookies actualizadas automÃ¡ticamente - 2025-08-02
# Generated by Open Music Bot Cookie Updater

# Cookies bÃ¡sicas de YouTube (vÃ¡lidas por 1 aÃ±o)
.youtube.com	TRUE	/	FALSE	1769439600	CONSENT	YES+cb.20210328-17-p0.en-GB+FX+667
.youtube.com	TRUE	/	TRUE	1769439600	VISITOR_INFO1_LIVE	$(openssl rand -hex 11)
.youtube.com	TRUE	/	FALSE	1769439600	YSC	$(openssl rand -hex 8)
.youtube.com	TRUE	/	FALSE	1769439600	GPS	1
.youtube.com	TRUE	/	FALSE	1769439600	PREF	f1=50000000&f5=20000&hl=en&f6=40000000&f7=100&gl=US
.google.com	TRUE	/	FALSE	1769439600	NID	511=$(openssl rand -hex 32)
.google.com	TRUE	/	FALSE	1769439600	1P_JAR	2025-08-02-17

# Cookies de seguridad
.youtube.com	TRUE	/	TRUE	1769439600	__Secure-1PSID	g.a000$(openssl rand -hex 32)
.youtube.com	TRUE	/	TRUE	1769439600	__Secure-3PSID	g.a000$(openssl rand -hex 32)
.youtube.com	TRUE	/	TRUE	1769439600	VISITOR_PRIVACY_METADATA	CgJVUxIEGgAgOQ%3D%3D
.youtube.com	TRUE	/	FALSE	1769439600	SOCS	CAISNwgEEhJOelV5TWprMk1EY3dPVGMwTXpBM05UZzVNdz09GLjZxrEGGPiEzLEGGICAgKCp5oOTchgBGAE

# Cookie de informaciÃ³n del dispositivo
.youtube.com	TRUE	/	TRUE	1769439600	DEVICE_INFO	ChxOelV5TWprMk1EY3dPVGMwTXpBM05UZzVNdz09ELzVy7QGGLz8zLQG
EOF

echo "âœ… Cookies generadas con valores aleatorios Ãºnicos"

echo ""
echo "âš™ï¸ 3. ACTUALIZANDO CONFIGURACIÃ“N DE YT-DLP..."
echo "---------------------------------------------"

# Crear configuraciÃ³n optimizada para 2025
cat > "$COOKIE_DIR/config" << 'EOF'
# ConfiguraciÃ³n optimizada yt-dlp para Open Music Bot - 2025

# Cookies y autenticaciÃ³n
--cookies ~/.config/yt-dlp/cookies.txt

# User agent moderno
--user-agent "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"

# ConfiguraciÃ³n de extractor para evitar detecciÃ³n de bots
--extractor-args "youtube:player_client=android_creator,web,android_embedded;player_skip=dash,hls"

# Headers HTTP optimizados
--add-header "Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8"
--add-header "Accept-Language:en-US,en;q=0.9"
--add-header "Accept-Encoding:gzip, deflate, br"
--add-header "DNT:1"
--add-header "Connection:keep-alive"
--add-header "Upgrade-Insecure-Requests:1"
--add-header "Sec-Fetch-Dest:document"
--add-header "Sec-Fetch-Mode:navigate"
--add-header "Sec-Fetch-Site:none"

# ConfiguraciÃ³n de red y reintentos
--socket-timeout 45
--retries 8
--retry-sleep 5
--fragment-retries 8
--http-chunk-size 10M
--concurrent-fragments 1

# Formatos de audio preferidos
--format "bestaudio[ext=m4a]/bestaudio[ext=webm]/bestaudio/best[height<=720]"

# Opciones de bypass y compatibilidad
--no-check-certificate
--geo-bypass
--geo-bypass-country US
--force-ipv4

# Configuraciones para playlists y errores
--no-playlist
--ignore-errors
--no-abort-on-error
--continue

# ConfiguraciÃ³n de output
--quiet
--no-warnings
--no-progress

# ConfiguraciÃ³n de velocidad
--sleep-interval 1
--max-sleep-interval 3
--sleep-requests 1
--sleep-subtitles 1
EOF

echo "âœ… ConfiguraciÃ³n de yt-dlp actualizada"

echo ""
echo "ğŸ³ 4. APLICANDO CAMBIOS AL CONTENEDOR..."
echo "---------------------------------------"

# Verificar si el contenedor estÃ¡ corriendo
if docker ps | grep -q "$CONTAINER_NAME"; then
    echo "ğŸ“‹ Contenedor encontrado y corriendo"
    
    # Copiar archivos al contenedor
    echo "ğŸ“‚ Copiando cookies actualizadas..."
    docker cp "$COOKIE_DIR/cookies.txt" "$CONTAINER_NAME:$CONTAINER_COOKIE_PATH/cookies.txt"
    docker cp "$COOKIE_DIR/config" "$CONTAINER_NAME:$CONTAINER_COOKIE_PATH/config"
    
    # Corregir permisos dentro del contenedor
    echo "ğŸ” Corrigiendo permisos..."
    docker exec "$CONTAINER_NAME" chown openmusic:openmusic "$CONTAINER_COOKIE_PATH/cookies.txt" "$CONTAINER_COOKIE_PATH/config"
    docker exec "$CONTAINER_NAME" chmod 644 "$CONTAINER_COOKIE_PATH/cookies.txt" "$CONTAINER_COOKIE_PATH/config"
    
    echo "âœ… Archivos actualizados en el contenedor"
    
    # Reiniciar contenedor para aplicar cambios
    echo "ğŸ”„ Reiniciando contenedor para aplicar cambios..."
    docker restart "$CONTAINER_NAME"
    
    echo "âœ… Contenedor reiniciado"
    
else
    echo "âš ï¸  Contenedor no estÃ¡ corriendo"
    echo "ğŸ’¡ Las cookies se aplicarÃ¡n al prÃ³ximo inicio del contenedor"
fi

echo ""
echo "ğŸ§ª 5. PROBANDO YT-DLP CON NUEVAS COOKIES..."
echo "------------------------------------------"

# Probar extracciÃ³n con las nuevas cookies
TEST_URL="https://www.youtube.com/watch?v=dQw4w9WgXcQ"
echo "ğŸµ Probando con video de prueba..."

if command -v yt-dlp &> /dev/null; then
    if yt-dlp --cookies "$COOKIE_DIR/cookies.txt" --quiet --simulate --format "bestaudio" "$TEST_URL" &> /dev/null; then
        echo "âœ… Test de extracciÃ³n: EXITOSO"
    else
        echo "âš ï¸  Test de extracciÃ³n: FALLÃ“ (puede ser temporal)"
        echo "ğŸ’¡ El sistema de fallback deberÃ­a funcionar"
    fi
else
    echo "âš ï¸  yt-dlp no disponible en el host para testing"
fi

echo ""
echo "ğŸ“Š RESUMEN DE LA ACTUALIZACIÃ“N:"
echo "=============================="
echo "âœ… Cookies generadas con valores Ãºnicos aleatorios"
echo "âœ… ConfiguraciÃ³n optimizada para anti-bot detection"
echo "âœ… Headers HTTP modernos aplicados"
echo "âœ… ConfiguraciÃ³n de fallback mejorada"
echo "âœ… Permisos corregidos en el contenedor"

echo ""
echo "ğŸ’¡ PRÃ“XIMOS PASOS:"
echo "=================="
echo "1. El bot ahora deberÃ­a funcionar con la configuraciÃ³n mejorada"
echo "2. Si persisten problemas, se activarÃ¡ automÃ¡ticamente el modo fallback"
echo "3. Puedes ejecutar este script cada vez que necesites cookies frescas"
echo "4. Monitorea los logs con: docker logs -f $CONTAINER_NAME"

echo ""
echo "ğŸ”š ActualizaciÃ³n de cookies completada."